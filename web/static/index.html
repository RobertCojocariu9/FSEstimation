<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <title>Freespace Estimation</title>
</head>
<body>
    <h1>Freespace Estimation</h1>
    <form id="upload-form">
        <h2>Upload RGB Image</h2>
        <input type="file" id="rgb-image" name="rgb-image" accept=".jpg,.jpeg,.png,.bmp">
        <br>
        <img id="rgb-preview" src="#" alt=""/>
        <h2>Upload Depth Map</h2>
        <input type="file" id="depth-image" name="depth-image" accept=".jpg,.jpeg,.png,.bmp">
        <br>
        <img id="depth-preview" src="#" alt=""/>
        <h2>Intrinsic Matrix</h2>
        <table id="intrinsic-params">
            <tr>
                <td><input type="text" id="fx-input" name="fx-input" oninput="validateNumericInput(event)" placeholder="fx"></td>
                <td>0</td>
                <td><input type="text" id="cx-input" name="cx-input" oninput="validateNumericInput(event)" placeholder="cx"></td>
            </tr>
            <tr>
                <td>0</td>
                <td><input type="text" id="fy-input" name="fy-input" oninput="validateNumericInput(event)" placeholder="fy"></td>
                <td><input type="text" id="cy-input" name="cy-input" oninput="validateNumericInput(event)" placeholder="cy"></td>
            </tr>
            <tr>
                <td>0</td>
                <td>0</td>
                <td>1</td>
            </tr>
        </table>
        <br>
        <button type="submit" id="submit-btn">Submit</button>
    </form>
    <br>
    <div id="result-div"></div>
    <script>
        function validateNumericInput(event) {
          const allowedCharacters = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.'];

          const inputChar = event.data;
          if (inputChar && !allowedCharacters.includes(inputChar)) {
            event.target.value = event.target.value.replace(inputChar, '');
          }
        }
        // Define the file input elements and previews
        const rgbInput = document.getElementById('rgb-image');
        const depthInput = document.getElementById('depth-image');
        const rgbPreview = document.getElementById('rgb-preview');
        const depthPreview = document.getElementById('depth-preview');

        // Add event listeners to the file input elements to show previews
        rgbInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                rgbPreview.src = event.target.result;
                rgbPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        depthInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                depthPreview.src = event.target.result;
                depthPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });
        // Define the submit button and result div
        const submitBtn = document.getElementById('submit-btn');
        const resultDiv = document.getElementById('result-div');

        // Define the function to handle form submission
        const handleFormSubmit = (event) => {
            event.preventDefault();

            resultDiv.innerHTML = "";
            
            // Get the uploaded files
            const rgbImage = document.getElementById('rgb-image').files[0];
            const depthImage = document.getElementById('depth-image').files[0];
            const fx = document.getElementById('fx-input').value;
            const cx = document.getElementById('cx-input').value;
            const fy = document.getElementById('fy-input').value;
            const cy = document.getElementById('cy-input').value;

            if (!rgbImage || !depthImage || fx === '' || cx === '' || fy === '' || cy === '') {
                alert('Please upload both images and fill in the intrinsic parameters.');
                return;
            }

            // Create a FormData object to send the files
            const formData = new FormData();
            formData.append('file1', rgbImage);
            formData.append('file2', depthImage);
            formData.append('fx', fx);
            formData.append('cx', cx);
            formData.append('fy', fy);
            formData.append('cy', cy);

            // Send an AJAX request to the server
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/predict', true);
			xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
            xhr.responseType = 'json';
            xhr.onload = () => {
                if (xhr.status === 200) {
                    // Decode and display the images
                    const img1Data = xhr.response.img1;
                    const img1Src = 'data:image/jpeg;base64,' + img1Data;
                    const img1 = document.createElement('img');
                    const img1Label = document.createElement('h2');
                    img1Label.textContent = 'Freespace prediction';
                    resultDiv.appendChild(img1Label);
                    resultDiv.appendChild(img1);
                    img1.src = img1Src;
                    resultDiv.appendChild(img1);
                } else {
                    const err = document.createElement('h2');
                    err.textContent = 'An error occcured. Try again later.';
                }
            };
            xhr.send(formData);
        };

        // Add a click event listener to the submit button
        submitBtn.addEventListener('click', handleFormSubmit);
    </script>
</body>
</html>
